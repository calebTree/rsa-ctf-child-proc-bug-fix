import subprocess
import sys
import psutil, os

RSA_CTF_HOME = '/home/kali/apps/RsaCtfTool'
TIMEOUT_S = 60
n = '26704136070190021268530677795105985884263361536622833934714426888426798665963518034656134699351969849578649269882577938793480570683691056722041783384495990587019100282789084323565697855562379540153332516779850690995663397706639210713389916468832374366672198412605881301513724575881325514230157189628217040662720724873409731892391430251108449468806031288847974398224502019544294525721217086971964279283183115289891371380447796261174525500007923713652805932399774761880950596925525730972278711118078161781852095293531902154870542539496778644054865834522716386911026357748701804307998796881754534349617288246197773646851'
# '602400691612422154516282778947806249229526581'

cmd = [
    'sage',
    f'{RSA_CTF_HOME}/sage/ecm.sage',
    n
]

# https://stackoverflow.com/questions/1230669/subprocess-deleting-child-processes-in-windows
def kill_proc_tree(pid, including_parent=True):    
    parent = psutil.Process(pid)
    children = parent.children(recursive=True)
    for child in children:
        child.kill()
    if including_parent:
        parent.kill()

try:
    p = subprocess.Popen(cmd)
    p.wait(timeout=TIMEOUT_S)
except subprocess.TimeoutExpired:
    print(f'Timeout for {cmd} ({TIMEOUT_S}s) expired', file=sys.stderr)
    print('Terminating the whole process group...', file=sys.stderr)
    kill_proc_tree(os.getpgid(p.pid))
